/*******************************************************************************
 * Industrial_Generic_Propanetank generated by Eliot.UELib using UELib.CLI.
 * Eliot.UELib Â© 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class Industrial_Generic_Propanetank extends Industrial_Generic
	collapsecategories;

var() noexport float DelayedExplosionTime "After the first time we take damage, we'll force destory ourselves if the timer runs out before we take enough damage.";
var() noexport float DelayedExplosionVariance "Variance for the DelayedExplosionTime";
var array<SoftParticleSystem> BulletFires;
var class<SoftParticleSystem> BulletFireClass;
var int NumHits;
var float damageAbsorbed;

final function Explode()
{
	CriticalDamage();
	return;
}

simulated function Destroyed()
{
	__NFUN_608__('Explode');
	StopBulletFire();
	super(dnDecoration).Destroyed();
	RemoveMountedActorListActors(false, false);
	return;
}

simulated event Engine.Actor.ETraceFireHitResponse TraceFireHit(Actor SourceActor, class<TraceDamageType> TraceDamageType, Vector SourceTraceOrigin, Vector HitLocation, Vector HitNormal, name HitBoneName, bool bExtentTrace)
{
	local Rotator FireRotation;

	// End:0x0C
	if(MPRoundNotInProgress())
	{
		return 0;
	}
	FireRotation = Rotator(HitNormal);
	FireRotation.Roll = 0;
	FireRotation.Pitch = 0;
	StartFireAtBulletEntry(HitLocation, FireRotation);
	return super(KarmaActor).TraceFireHit(SourceActor, TraceDamageType, SourceTraceOrigin, HitLocation, HitNormal, HitBoneName, bExtentTrace);
	return;
}

event TakeDamage(Pawn Instigator, float Damage, Vector DamageOrigin, Vector DamageDirection, class<DamageType> DamageType, optional name HitBoneName, optional Vector DamageStart)
{
	local Vector SpawnLoc;
	local Rotator FireRotation;

	// End:0x0B
	if(MPRoundNotInProgress())
	{
		return;
	}
	super(dnDecoration).TakeDamage(Instigator, 0, DamageOrigin, DamageDirection, DamageType, HitBoneName, DamageStart);
	__NFUN_209__(damageAbsorbed, Damage);
	__NFUN_184__(NumHits);
	// End:0x168
	if(__NFUN_148__(__NFUN_200__(damageAbsorbed, Health), __NFUN_169__(NumHits, 4)))
	{
		// End:0x84
		if(__NFUN_173__(NumHits, 1))
		{
			__NFUN_607__(__NFUN_226__(DelayedExplosionTime, DelayedExplosionVariance), false, 'Explode');
		}
		// End:0x165
		if(__NFUN_173__(string(BulletFires), 0))
		{
			FireRotation.Pitch = 16384;
			FireRotation = __NFUN_269__(FireRotation, Rotation);
			SpawnLoc = __NFUN_238__(Location, __NFUN_241__(__NFUN_232__(0, 0, __NFUN_195__(0.75, CollisionHeight)), Rotation));
			StartFireAtBulletEntry(SpawnLoc, FireRotation);
			SpawnLoc = __NFUN_238__(Location, __NFUN_241__(__NFUN_232__(45, 0, __NFUN_195__(0.75, CollisionHeight)), Rotation));
			StartFireAtBulletEntry(SpawnLoc, FireRotation);
			SpawnLoc = __NFUN_238__(Location, __NFUN_241__(__NFUN_232__(-45, 0, __NFUN_195__(0.75, CollisionHeight)), Rotation));
			StartFireAtBulletEntry(SpawnLoc, FireRotation);
		}		
	}
	else
	{
		CriticalDamage();
	}
	return;
}

function StartFireAtBulletEntry(Vector BulletEntry, Rotator FireRotation)
{
	// End:0x64
	if(__NFUN_145__(DecorationIsDead()))
	{
		BulletFires[BulletFires.Add(1)] = __NFUN_615__(BulletFireClass,,, BulletEntry, FireRotation);
		BulletFires[__NFUN_166__(string(BulletFires), 1)].MountType = 0;
		BulletFires[__NFUN_166__(string(BulletFires), 1)].__NFUN_635__(self, false, false, true);
	}
	return;
}

function StopBulletFire()
{
	local int i;

	i = __NFUN_166__(string(BulletFires), 1);
	J0x0F:

	// End:0x4A [Loop If]
	if(__NFUN_172__(i, 0))
	{
		BulletFires[i].__NFUN_1054__();
		BulletFires[i].__NFUN_614__();
		__NFUN_185__(i);
		// [Loop Continue]
		goto J0x0F;
	}
	BulletFires.Remove(0, string(BulletFires));
	return;
}

event RegisterPrecacheComponents(PrecacheIndex PrecacheIndex)
{
	super(dnDecoration).RegisterPrecacheComponents(PrecacheIndex);
	PrecacheIndex.__NFUN_1266__(BulletFireClass);
	return;
}

defaultproperties
{
	DelayedExplosionTime=3
	DelayedExplosionVariance=0.5
	BulletFireClass='p_Decorations.Oil_Fire.OilFire_Main'
	DecoActivities_Default(0)=(ActivityData=(bInitialized=false,CurrentIndex=0,NextPerformTime=0,NextPerformTime_Failure=0),ActivityIDScript=none,ActivityID=(21),ActivityMethod=0,ActivityStates_Success=none,ActivityStates_Failure=none,ActivityDebugID="",Activities=((ActivityRules=none,ActivityElements=('dnGame.DecoActivityDeclarations.DA_Camera_Explosion_Shake_Generic'),ActivitySetup=(bDisabled=false,bPerformedThisRound=false,PerformedCounter=0,LoopCount=0,PerformAgainDelay=0),FailureActivityElements=none,FailureActivitySetup=(bDisabled=false,bPerformedThisRound=false,PerformedCounter=0,LoopCount=0,PerformAgainDelay=0))),bDisabled=false)
	bSurviveDeath=true
	DestroyedActivities(0)=none
	begin object name=DA_Sound_Industrial_PropaneTank_Explode class=DecoActivities_Sound
		SoundNames(0)=Propane_Explode
	object end
	// Reference: DecoActivities_Sound'Industrial_Generic_Propanetank.DA_Sound_Industrial_PropaneTank_Explode'
	DestroyedActivities(1)=DA_Sound_Industrial_PropaneTank_Explode
	begin object name=DA_Display_Generic_Propanetank class=DecoActivities_Display
		RenderObject='sm_class_decorations.Propanetank.Propanetank_Gib1'
	object end
	// Reference: DecoActivities_Display'Industrial_Generic_Propanetank.DA_Display_Generic_Propanetank'
	DestroyedActivities(2)=DA_Display_Generic_Propanetank
	begin object name=DA_RadiusDamage_Propanetank class=DA_RadiusDamage_Standard
		Damage=200
		Radius=400
	object end
	// Reference: DA_RadiusDamage_Standard'Industrial_Generic_Propanetank.DA_RadiusDamage_Propanetank'
	DestroyedActivities(3)=DA_RadiusDamage_Propanetank
	HealthPrefab=5
	Health=75
	SpawnOnDestroyed(0)=(SpawnClass='Industrial_Generic_Propanetank_Gib2',RenderObject=none,DrawScale=0,DrawScaleVariance=0,DrawScale3D=(X=1.291717E-41,Y=2.797242E-17,Z=0),Z=0)
	SpawnOnDestroyed(1)=(SpawnChance=0,SpawnCopies=0,SpawnCopiesVariance=0,bIgnorePawnAirCushion=false,bDontScaleByDrawScale=false,bScaleByDrawScaleNonDefault=false,bNoCollision=false,bFindSpot=false,bIgnoreParentRotation=false,bTakeParentCollisionSize=false,bTakeParentMounting=false,bTakeParentActorColors=false,bTakeParentSkins=false,Offset=(X=1.291717E-41,Y=2.813687E-17,Z=1),Z=17)
	SpawnOnDestroyed(2)=(OffsetVariance=(X=1.291717E-41,Y=2.797242E-17,Z=0),Z=0)
	SpawnOnDestroyed(3)=(Rotation=(Pitch=8709,Yaw=571080704,Roll=0),Roll=0)
	SpawnOnDestroyed(4)=(RotationVariance=(Pitch=8709,Yaw=571080704,Roll=0),Roll=0)
	SpawnOnDestroyed(5)=(BoneName=None,MotionInfo=MotionPrefab'Industrial_Generic_Propanetank.MP_Propanetank_Gibs')
	SpawnOnDestroyed(6)=(SpawnClass='Industrial_Generic_Propanetank_Gib3',RenderObject=none,DrawScale=0,DrawScaleVariance=0,DrawScale3D=(X=1.291717E-41,Y=2.797242E-17,Z=0),Z=0)
	SpawnOnDestroyed(7)=(SpawnChance=0,SpawnCopies=0,SpawnCopiesVariance=0,bIgnorePawnAirCushion=false,bDontScaleByDrawScale=false,bScaleByDrawScaleNonDefault=false,bNoCollision=false,bFindSpot=false,bIgnoreParentRotation=false,bTakeParentCollisionSize=false,bTakeParentMounting=false,bTakeParentActorColors=false,bTakeParentSkins=false,Offset=(X=1.291717E-41,Y=2.802873E-17,Z=0),Z=18)
	SpawnOnDestroyed(8)=(OffsetVariance=(X=1.291717E-41,Y=2.797242E-17,Z=0),Z=0)
	DestroyedParticleFriendEffects(0)=(bAbsoluteLocation=false,bAbsoluteRotation=false,Scale=0,BoneName=None,Location=(X=1.291717E-41,Y=2.813698E-17,Z=0),Z=0)
	DestroyedParticleFriendEffects(1)=(Rotation=(Pitch=8709,Yaw=571080704,Roll=0),Roll=0)
	DestroyedParticleFriendEffects(2)=(Effect='p_Decorations.BarrelExplosion.Barrel_Explosion_Spawner')
	PhysicsEntityGroup=PropaneTankGibs
	bBlockPath=true
	bAlwaysRelevant=true
	CollisionRadius=50
	CollisionHeight=32
	StaticMesh='sm_class_decorations.Propanetank.Propanetank'
}