/*******************************************************************************
 * dnControl_PigCop_Grapple generated by Eliot.UELib using UELib.CLI.
 * Eliot.UELib Â© 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class dnControl_PigCop_Grapple extends dnControl_TapPowered
	collapsecategories;

var() deprecated PigCop_Grunt PIGCOP;
var float DamageRate;
var float Damage;
var float FailTimer;
var name GridAnim;
var SMountPrefab PigCopMountPrefab;
var name LoopSoundName;

simulated event Actor GetIKActor(name LimbID)
{
	return PIGCOP;
	return;
}

simulated event bool UsableSomething_AIShouldIgnoreUser()
{
	return true;
	return;
}

final function TakeControlOfPigCop()
{
	// End:0x0E
	if(__NFUN_339__(PIGCOP, none))
	{
		return;
	}
	PIGCOP.SuspendExecutive(true);
	PIGCOP.SuspendLookTargetEvaluation(true);
	PIGCOP.SuspendWeaponTargetEvaluation(true);
	PIGCOP.TickStyle = 3;
	PIGCOP.bDontModifyHeadSize = true;
	PIGCOP.__NFUN_642__(9);
	PIGCOP.StoreCollision();
	PIGCOP.__NFUN_621__(false, false, false, false, false);
	PIGCOP.SetAnimSync(2, 2, 2, 2, 2);
	PIGCOP.EndNonOPPain();
	return;
}

final function MountPigCop()
{
	local SDesiredLocation DesiredLocation;

	// End:0x0E
	if(__NFUN_339__(PIGCOP, none))
	{
		return;
	}
	PIGCOP.__NFUN_635__(self,,, true);
	DesiredLocation.Target = PigCopMountPrefab.MountOrigin;
	DesiredLocation.TimeTotal = InterpolationInTime;
	PIGCOP.bUseNormalPhysicsRotation = true;
	PIGCOP.__NFUN_650__(DesiredLocation);
	PIGCOP.__NFUN_663__(PigCopMountPrefab.MountAngles,, DesiredLocation.TimeTotal,,,,,,, true);
	return;
}

final function ReleaseControlOfPigCop()
{
	// End:0x0E
	if(__NFUN_339__(PIGCOP, none))
	{
		return;
	}
	PIGCOP.DestroyOnDismount = false;
	PIGCOP.__NFUN_631__();
	PIGCOP.TickStyle = PIGCOP.default.TickStyle;
	PIGCOP.RestoreCollision();
	PIGCOP.__NFUN_642__(PIGCOP.default.Physics);
	PIGCOP.bUseNormalPhysicsRotation = PIGCOP.default.bUseNormalPhysicsRotation;
	PIGCOP.SuspendExecutive(false);
	PIGCOP.SuspendLookTargetEvaluation(false);
	PIGCOP.SuspendWeaponTargetEvaluation(false);
	PIGCOP.SetExecutive(2);
	PIGCOP = none;
	return;
}

simulated function AttachPawnSuccess(Pawn Attachee, optional bool bForced)
{
	TakeControlOfPigCop();
	__NFUN_645__(__NFUN_239__(Attachee.Location, __NFUN_232__(0, 0, Attachee.CollisionHeight)));
	__NFUN_652__(Attachee.Rotation);
	// End:0x60
	if(__NFUN_340__(InternalControlRemapper, none))
	{
		InternalControlRemapper.__NFUN_630__();
	}
	super(dnControl).AttachPawnSuccess(Attachee, bForced);
	// End:0x8F
	if(__NFUN_340__(User, none))
	{
		User.bNoDamage = true;
	}
	MountPigCop();
	return;
}

simulated function DetachPawnSuccess(bool bForced)
{
	super(dnControl).DetachPawnSuccess(bForced);
	// End:0x2A
	if(__NFUN_340__(User, none))
	{
		User.bNoDamage = false;
	}
	return;
}

simulated function PlayUserAnim()
{
	super(dnControl).PlayUserAnim();
	// End:0x71
	if(__NFUN_148__(__NFUN_148__(__NFUN_342__(States[CurrentStateIndex].UserAnimName, 'None'), __NFUN_340__(PIGCOP, none)), __NFUN_340__(PIGCOP.AnimationController, none)))
	{
		PIGCOP.AnimationController.SetAnimState(States[CurrentStateIndex].UserAnimName);
	}
	return;
}

final simulated function DamagePlayer()
{
	local float DamageAmount;

	// End:0xCD
	if(__NFUN_340__(User, none))
	{
		DamageAmount = Damage;
		// End:0x53
		if(__NFUN_201__(DamageAmount, User.Health))
		{
			DamageAmount = __NFUN_225__(0, __NFUN_199__(User.Health, 1));
		}
		User.bNoDamage = false;
		User.TakeDamage(PIGCOP, DamageAmount, User.Location, __NFUN_235__(float(-1), Vector(User.Rotation)), class'MeleeDamage',, PIGCOP.Location);
		User.bNoDamage = true;
	}
	return;
}

final simulated function FailTimerFunc()
{
	// End:0x26
	if(__NFUN_145__(PlayerPawn(User).bGodMode))
	{
		ControlEvent(, 'Fail');
	}
	return;
}

function CheckEarlyDetach()
{
	// End:0x52
	if(__NFUN_150__(__NFUN_150__(__NFUN_339__(PIGCOP, none), PIGCOP.__NFUN_921__()), User.__NFUN_921__()))
	{
		// End:0x42
		if(__NFUN_340__(PIGCOP, none))
		{
			ReleaseControlOfPigCop();
		}
		User.ForceDetachCompleteFromUsableSomething();
	}
	return;
}

event RegisterPrecacheComponents(PrecacheIndex PrecacheIndex)
{
	super.RegisterPrecacheComponents(PrecacheIndex);
	PrecacheIndex.__NFUN_1277__(class'DukePlayer'.default.VoicePack, 'MeleeDeathImpacts');
	PrecacheIndex.__NFUN_1277__(class'PigCop_Grunt'.default.VoicePack, 'Sound_Executed');
	PrecacheIndex.__NFUN_1279__(class'MeleeDamage');
	PrecacheIndex.__NFUN_1279__(class'CrushingDamage');
	PrecacheIndex.__NFUN_1277__(VoicePack, LoopSoundName);
	PrecacheIndex.__NFUN_1281__(GridAnim);
	PrecacheIndex.__NFUN_1277__(class'VoicePack_Duke', 'Rage_VOC');
	PrecacheIndex.__NFUN_1277__(class'VoicePack_Duke', 'STR_BerzPig_NeckBreak');
	return;
}

state() AttachUserAnim
{
	event Tick(float DeltaSeconds)
	{
		super(dnControl).Tick(DeltaSeconds);
		CheckEarlyDetach();
		return;
	}
	stop;
}

state() idle
{
	event BeginState()
	{
		super(Object).BeginState();
		__NFUN_607__(DamageRate, true, 'DamagePlayer');
		__NFUN_607__(FailTimer, true, 'FailTimerFunc');
		FindAndPlaySound(LoopSoundName);
		return;
	}

	event EndState()
	{
		super(Object).EndState();
		__NFUN_608__('DamagePlayer');
		__NFUN_608__('FailTimerFunc');
		FindAndStopSound(LoopSoundName);
		return;
	}

	function FullyLifted()
	{
		super(dnControl_TapPowered).FullyLifted();
		ControlEvent(, 'Success');
		return;
	}

	function UpdateUserLift()
	{
		super(dnControl_TapPowered).UpdateUserLift();
		User.AnimationController.SetAnimGridState(GridAnim, UserLiftVal);
		// End:0x72
		if(__NFUN_148__(__NFUN_340__(PIGCOP, none), __NFUN_340__(PIGCOP.AnimationController, none)))
		{
			PIGCOP.AnimationController.SetAnimGridState(GridAnim, UserLiftVal);
		}
		CheckEarlyDetach();
		return;
	}
	stop;
}

state() Success
{
	function AnimCallback_UserAnimEnd()
	{
		super(dnControl).AnimCallback_UserAnimEnd();
		DetachPawnSuccess(false);
		return;
	}

	simulated function InteractUser(Pawn User)
	{
		super(InteractiveActor).InteractUser(User);
		// End:0x90
		if(__NFUN_340__(PIGCOP, none))
		{
			PIGCOP.DeathAnimChance = 0;
			PIGCOP.FindSoundAndSpeak('Sound_Executed');
			PIGCOP.Died(User, int(PIGCOP.Health), PIGCOP.Location, __NFUN_232__(0, 0, 0), class'MeleeDamage', 'Root');
		}
		return;
	}
	stop;
}

state() Fail
{
	function AnimCallback_UserAnimEnd()
	{
		User.bNoDamage = false;
		super(dnControl).AnimCallback_UserAnimEnd();
		User.FindAndPlaySound('MeleeDeathImpacts', 1);
		User.Died(PIGCOP, int(User.Health), User.Location, __NFUN_233__(Vector(Rotation)), class'CrushingDamage', 'Root');
		// End:0x87
		if(__NFUN_340__(PIGCOP, none))
		{
			ReleaseControlOfPigCop();
		}
		return;
	}
	stop;
}

defaultproperties
{
	DamageRate=1
	Damage=20
	FailTimer=5
	GridAnim=PigCop_Grapple_Grid
	PigCopMountPrefab=(bDontActuallyMount=false,bHideable=false,bIndependentRotation=false,bIndependentLocation=false,bMatchParentLocation=false,bMatchParentRotation=false,bSurviveDismount=false,bDontScaleByDrawScale=false,bScaleByDrawScaleNonDefault=false,bTransformDrawScale3DChange=false,bTakeParentTag=false,bTransferToCorpse=false,bDontSetOwner=false,MountParentTag=None,DrawScaleOverride=0,AppendToTag=None,ForceTag=None,ForceEvent=None,MountMeshItem=None,MountOrigin=(X=-4.801393E+28,Y=3.778672E-17,Z=0),Z=45)
	LoopSoundName=STR_Motion_Generic
	bForceDrop=false
	StartTapInterval=0.5
	EndTapInterval=0.3
	RateOfGain=0.05
	RateOfLoss=0.2
	TapUsePhrase="<?int?dnAI.dnControl_PigCop_Grapple.TapUsePhrase?>"
}